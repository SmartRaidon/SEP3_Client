@page "/profile"
@using System.Security.Claims
@using ApiContracts
@using BlazorApp.Auth
@using BlazorApp.Services

@inject IUserService UserService
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

<AuthorizeView>
    <Authorized>
        <h3>Profile</h3>

        <div class="d-flex mt-4">
            <div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png?20170328184010" 
                     alt="Profile picture placeholder"
                     class="img-fluid flex-shrink-1 mx-xxl-5"
                     style="border: 5px solid #8B4513; border-radius: 50px; max-width: 300px;">
            </div>
            
            @if (_user == null)
            {
                <p><em>Loading...</em></p>
            }
            else
            {
                @if (!_isEditingUsername && !_isEditingPassword)
                {
                    <div class="flex-column">
                        <div>
                            <h3>ID</h3>
                            <input type="text" id="idInput" class="form-control mt-1 text-center" style="width: 300px;" value="@userid" readonly/>
                        </div>
                        <div>
                            <h3>E-mail</h3>
                            <input type="text" id="emailInput" class="form-control mt-1 text-center" style="width: 300px;" value="@email" readonly/>
                        </div>
                        <div>
                            <h3>Username</h3>
                            <input type="text" id="usernameInput" class="form-control mt-1 text-center" style="width: 300px;" value="@username" readonly/>
                        </div>
                        <div class="mt-5">
                            <button class="btn btn-primary" @onclick="EnableUsernameEditing">✏️ Change username</button>
                        </div>
                        <div class="mt-1">
                            <button class="btn btn-primary" @onclick="EnablePasswordEditing">✏️ Change password</button>
                        </div>
                    </div>
                }
                @if (_isEditingUsername)
                {
                    <div class="flex-column">

                        <h3>Edit Username</h3>

                        <input type="text"
                               class="form-control mx-auto mt-2 text-center"
                               style="width: 300px;"
                               placeholder="New username"
                               @bind="_newUsername" />

                        <div class="mt-3">
                            <button class="btn btn-success me-2" @onclick="SaveUsername">💾 Save</button>
                            <button class="btn btn-secondary" @onclick="CancelEditing">Cancel</button>
                        </div>
                    </div>
                }
                else if (_isEditingPassword)
                {
                    <div class="flex-column">

                        <h3>Change Password</h3>

                        <input type="password"
                               class="form-control mx-auto mt-2 text-center"
                               style="width: 300px;"
                               placeholder="New password"
                               @bind="_newPassword" />

                        <input type="password"
                               class="form-control mx-auto mt-2 text-center"
                               style="width: 300px;"
                               placeholder="Repeat password"
                               @bind="_repeatPassword" />

                        @if (!string.IsNullOrEmpty(_passwordError))
                        {
                            <div class="text-danger mt-2">@_passwordError</div>
                        }

                        <div class="mt-3">
                            <button class="btn btn-success me-2" @onclick="SavePassword">💾 Save</button>
                            <button class="btn btn-secondary" @onclick="CancelEditing">Cancel</button>
                        </div>
                    </div>
                }
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <p>ACCESS DENIED: You are not logged in.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    private bool _isEditingUsername = false;
    private bool _isEditingPassword = false;
    private string _newPassword = "";
    private string _repeatPassword = "";
    private string _passwordError = "";
    private string _newUsername = "";
    private string _usernameError = "";
    private UserDto? _user;
    private string? username;
    private string? email;
    private string? userid;
    
    protected override async Task OnInitializedAsync()
    {
        AuthenticationState authenticationState = await State;
        ClaimsPrincipal principal = authenticationState.User;
        if (principal.Identity is null || !principal.Identity.IsAuthenticated)
        {
            // the user is not logged in
            return;
        }
        username = principal.Identity.Name;
        IEnumerable<Claim> claims = principal.Claims;
        userid = claims.Single(c => c.Type == ClaimTypes.NameIdentifier).Value;
        email = claims.Single(c => c.Type == ClaimTypes.Email).Value;

        _user = await UserService.GetUserAsync(Convert.ToInt32(userid));
    }
    
    private void EnableUsernameEditing() => _isEditingUsername = true;
    private void EnablePasswordEditing() => _isEditingPassword = true;
    private void CancelEditing()
    {
        _isEditingUsername = false;
        _isEditingPassword = false;
    }
    
    private async Task SavePassword()
    {
        _passwordError = "";
        
        if (_newPassword != _repeatPassword)
        {
            _passwordError = "Passwords do not match.";
            await InvokeAsync(StateHasChanged);
            return;
        }
        
        if (_newPassword.Length < 8)
        {
            _passwordError = "Password must be at least 8 characters.";
            await InvokeAsync(StateHasChanged);
            return;
        }
        
        await UserService.ChangePasswordAsync(Convert.ToInt32(userid), _newPassword);
        
        _newPassword = "";
        _repeatPassword = "";
        CancelEditing();
        await ((SimpleAuthProvider)AuthProvider).Logout();
        Navigation.NavigateTo("/login");
    }
    
    private async Task SaveUsername()
    {
        _usernameError = "";
        
        if (_newUsername.Length < 5)
        {
            _passwordError = "Username must be at least 5 characters.";
            await InvokeAsync(StateHasChanged);
            return;
        }
        
        await UserService.ChangeUsernameAsync(Convert.ToInt32(userid), _newUsername);
        
        _newUsername = "";
        CancelEditing();
        await ((SimpleAuthProvider)AuthProvider).Logout();
        Navigation.NavigateTo("/login");
    }
}