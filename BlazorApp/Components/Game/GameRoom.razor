@page "/game-room"
@page "/game-room/{InviteCode}"

@using System.Linq
@using System.Security.Claims
@using ApiContracts
@using BlazorApp.Services

@inject NavigationManager Nav
@inject IGameService SignalRService

@if (!_connectedToServer)
{
    <div class="text-center mt-5">
        <h3>@_connectionStatus</h3>
        <button class="btn btn-primary mt-3" @onclick="Reconnect">
            Try Again
        </button>
    </div>
}
else
{
    <div class="d-flex justify-content-center align-items-center">
        <div class="text-center">
            <h1>Player X</h1>
            <label>@playerXName</label>
            <label>@PlayerXId</label>
        </div>
        <div class="tictactoebox">
            <div class="board" role="grid" aria-label="Tic Tac Toe board">
                @for (int i = 0; i < 9; i++)
                {
                    var index = i;   // <<< EZ A SOR A LÉNYEG

                    <button class="cell @(WinningCells?.Contains(index) == true ? "winning-cell" : "")"
                            role="gridcell"
                            aria-label="Cell @index"
                            @onclick="@(async () => await OnCellClick(index))"
                            disabled="@(CellsDisabled[index])">
                        <span class="mark">@Marks[index]</span>
                    </button>
                }
            </div>
            <div class="controls">
                <div class="status">@StatusMessage</div>
            </div>
        </div>
        <div class="text-center">
            <h1>Player O</h1>
            <label>@playerOName</label>
            <label>@PlayerOId</label>
        </div>
    </div>

    if (GameEnded)
    {
        <div class="overlay">
            <div class="end-card">
                <h2>@EndMessage</h2>

                <button class="btn btn-primary m-2" @onclick="RequestReplay">
                    Replay
                </button>

                <button class="btn btn-secondary m-2" @onclick="GoToMenu">
                    Main Menu
                </button>
            </div>
        </div>
    }
}

@code {
    
    [Parameter] public string? InviteCode { get; set; }
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    private string? userIdAsString;
    private string username;
    private bool _connectedToServer = false;
    private string _connectionStatus = "Connecting to logic server...";

    private string[] Marks = Array.Empty<string>();
    private bool[] CellsDisabled = Array.Empty<bool>();
    private string StatusMessage = "Waiting for opponent...";
    private string EndMessage = "";

    private int GameId;
    private int CurrentPlayerId = -1;   //
    private int PlayerXId;
    private string playerXName;
    private int? PlayerOId;
    private string playerOName;
    private int CurrentTurnPlayerId;
    private int[]? WinningCells;
    private bool GameEnded = false;

    private void GoToMenu()
    {
        Nav.NavigateTo("/");
    }
    
    protected override async Task OnInitializedAsync()
    {
        AuthenticationState authenticationState = await State;
        ClaimsPrincipal principal = authenticationState.User;
        if (principal.Identity is null || !principal.Identity.IsAuthenticated)
        {
            // the user is not logged in
            return;
        }

        username = principal.Identity.Name;
        IEnumerable<Claim> claims = principal.Claims;
        userIdAsString = claims.Single(c => c.Type == ClaimTypes.NameIdentifier).Value;
        CurrentPlayerId = Convert.ToInt32(userIdAsString);

        // 9x cells
        Marks = Enumerable.Repeat(string.Empty, 9).ToArray();
        CellsDisabled = Enumerable.Repeat(false, 9).ToArray();

        try
        {
            _connectionStatus = "Connecting to logic server...";
            
            // subscribing to events
            await SignalRService.OnMoveMade(UpdateBoard);
            await SignalRService.OnGameUpdated(OnGameUpdated);
            await SignalRService.OnGameFinished(OnGameFinished);
            await SignalRService.OnReplayStarted(OnReplayStarted);

            Console.WriteLine("[GameRoom] Starting SignalR...");
            await SignalRService.StartAsync();
            
            GameDTO game;
            
            if (!string.IsNullOrWhiteSpace(InviteCode))
            {
                // GUEST: joins with inv code
                Console.WriteLine($"[GameRoom] Joining existing game with invite code {InviteCode}...");
                game = await SignalRService.JoinGameAsync(InviteCode, CurrentPlayerId, username);
            }
            else
            {
                // HOST: creating new game
                Console.WriteLine("[GameRoom] Creating new game...");
                game = await SignalRService.CreateGameAsync(CurrentPlayerId, username);
                Nav.NavigateTo($"/game-room/{game.InviteCode}", forceLoad: false);
            }

            GameId = game.Id;
            PlayerXId = game.PlayerXId;
            PlayerOId = game.PlayerOId;
            playerXName = game.PlayerXName;
            playerOName = game.PlayerOName;

            if (game.Status == "WaitingForOpponent")
            {
                StatusMessage = $"Invite code: {game.InviteCode}";
            }
            else
            {
                StatusMessage = "Game in progress...";
            }
            
            Console.WriteLine($"[GameRoom] Game ready. Id={GameId}, Invite={game.InviteCode}");

            _connectedToServer = true;
            _connectionStatus = "Connected!";
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine("[GameRoom] Could not connect to logic server: " + ex);
            _connectedToServer = false;
            _connectionStatus = "Error: " + ex.Message;
        }
    }

    private async Task OnCellClick(int index)
    {
        Console.WriteLine($"[GameRoom] OnCellClick({index}) called");

        if (!_connectedToServer 
            || index < 0 
            || index >= Marks.Length 
            || CellsDisabled[index] 
            || CurrentTurnPlayerId != CurrentPlayerId) // enforce turn
            return;
        
        // optimistically update UI
        Marks[index] = CurrentPlayerId == PlayerXId ? "X" : "O";
        CellsDisabled[index] = true;
        StatusMessage = CurrentTurnPlayerId == CurrentPlayerId
            ? "Your turn!"
            : "Waiting for opponent...";
        await InvokeAsync(StateHasChanged);

        Console.WriteLine($"[GameRoom] Sending move: game={GameId}, player={CurrentPlayerId}, pos={index}");
        await SignalRService.SendMoveAsync(GameId, CurrentPlayerId, index);
    }

    private Task UpdateBoard(MoveDTO move)
    {
        Console.WriteLine($"[GameRoom] Move received: game={move.GameId}, player={move.PlayerId}, pos={move.Position}");

        string mark = move.PlayerId == PlayerXId ? "X" : "O";

        if (move.Position >= 0 && move.Position < Marks.Length)
        {
            Marks[move.Position] = mark;
            CellsDisabled[move.Position] = true;
        }

        StatusMessage = CurrentTurnPlayerId == CurrentPlayerId 
            ? "Your turn!" 
            : "Waiting for opponent...";
        return InvokeAsync(StateHasChanged);
    }

    private Task OnGameUpdated(GameDTO game)
    {
        Console.WriteLine("[GameRoom] GameUpdated received");
        GameId = game.Id;
        PlayerXId = game.PlayerXId;
        PlayerOId = game.PlayerOId;
        playerOName = game.PlayerOName;

        for (int i = 0; i < game.Board.Length && i < 9; i++)
        {
            int cell = game.Board[i];
            Marks[i] = cell == 1 ? "X" : cell == 2 ? "O" : string.Empty;
            CellsDisabled[i] = cell != 0;
        }

        // update winning cells
        WinningCells = game.WinningCells;

        // set next turn
        CurrentTurnPlayerId = game.NextPlayerId;

        if (game.Status == "Finished")
        {
            if (game.WinnerId.HasValue)
            {
                string winnerMark =
                    game.WinnerId == PlayerXId ? "X" :
                        (PlayerOId.HasValue && game.WinnerId == PlayerOId.Value ? "O" : "?");
                StatusMessage = $"Game over. {winnerMark} wins!";
            }
            else
            {
                StatusMessage = "Game over. Draw!";
            }

            // disable all cells
            for (int i = 0; i < CellsDisabled.Length; i++)
                CellsDisabled[i] = true;

            EndMessage = StatusMessage;
            GameEnded = true;
        }
        else
        {
            StatusMessage = CurrentTurnPlayerId == CurrentPlayerId
                ? "Your turn!"
                : "Waiting for opponent...";
        }

        return InvokeAsync(StateHasChanged);
    }


    private Task OnGameFinished(GameDTO game)
    {
        if (game.WinnerId.HasValue)
        {
            string winnerMark =
                game.WinnerId == PlayerXId ? "X" :
                    (PlayerOId.HasValue && game.WinnerId == PlayerOId.Value ? "O" : "?");
            StatusMessage = $"Game over. {winnerMark} wins!";
        }
        else
        {
            StatusMessage = "Game over. Draw!";
        }
        
        WinningCells = game.WinningCells;
        
        // disable all cells
        for (int i = 0; i < CellsDisabled.Length; i++)
            CellsDisabled[i] = true;
        
        EndMessage = StatusMessage;
        GameEnded = true;

        return InvokeAsync(StateHasChanged);
    }
    
    private async Task Reconnect()
    {
        if (!_connectedToServer)
        {
            _connectionStatus = "Reconnecting...";
            await SignalRService.StartAsync();
        }
    }
    
    private async Task RequestReplay()
    {
        Console.WriteLine("[GameRoom] Replay requested");

        StatusMessage = "Replay requested. Waiting for opponent...";
        EndMessage = StatusMessage;
        GameEnded = false; // hide overlay while waiting - maybe maybe
        await SignalRService.RequestReplayAsync(GameId, CurrentPlayerId);
        await InvokeAsync(StateHasChanged);
    }
    
    private Task OnReplayStarted(GameDTO game)
    {
        Console.WriteLine("[GameRoom] Replay started");

        for (int i = 0; i < 9; i++)
        {
            Marks[i] = string.Empty;
            CellsDisabled[i] = false;
        }

        WinningCells = null;
        GameEnded = false;

        CurrentTurnPlayerId = game.NextPlayerId;
        StatusMessage = CurrentTurnPlayerId == CurrentPlayerId
            ? "Your turn!"
            : "Waiting for opponent...";

        return InvokeAsync(StateHasChanged);
    }
}
